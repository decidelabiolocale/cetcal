$(document).ready(function() {
  
  $('#espace-prd-demande-update-qstprod-form-button').on('mousedown', function() {

    $('#cet-modal-alerte-titre').text("Modification de vos données producteur.e");
    $('#cet-modal-alerte-paragraphe').text("Vous allez-être redirigé vers les formulaires Producteur.e. Veuillez vous munir de votre certification AB ainsi que des informations liées à votre ferme (n° de SIRET, lieux de distribution...).");
    $('#cet-modal-alerte-btn-annuler').text("Annuler");
    $('#cet-modal-alerte-btn-annuler').show();
    $('#cet-modal-alerte-btn-primary').text("Modifier mes informations");
    $('#cet-modal-alerte-btn-primary').off();
    $('#cet-modal-alerte-btn-primary').on('mousedown', function() { 
      $('#cet-modal-alerte').modal('hide');
      $('#espace-prd-demande-update-qstprod-form-button-submit').click();
    });
    $('#cet-modal-alerte-btn-annuler').off();
    $('#cet-modal-alerte-btn-annuler').on('mousedown', function() { 
      $('#cet-modal-alerte').modal('hide'); 
    });
    $('#cet-modal-alerte-btn').click();
  });

  $('#espace-prd-modifier-mdp').on('mousedown', function() {
    unFocusContainersExcept('espace-prd-mdif-global-container');
    $('#data-mdp-espace-producteur-container').show('slow');
  });

  $('#espace-prd-modifier-geoloc').on('mousedown', function() {
    
    var pkprd = $(this).attr('data');
    var sitkn = $(this).attr('sitkn');
    var usridf = $(this).attr('usridf');

    $.ajax({
      url: '/src/app/controller/ajaxhandlers/cet.qstprod.controller.ajaxhandler.geoloc.producteur.php'
        + '?action=get' 
        + '&pkprd=' + pkprd 
        + '&sitkn=' + sitkn 
        + '&usridf=' + usridf,
      success: function(json) {
        var data = JSON.parse(json);
        $('#etat-mdif-geoloc-producteur').html(data.msg);
        $('#data-geoloc-espace-producteur-latlng').val(data.lat + ';' + data.lng);
        unFocusContainersExcept('espace-prd-mdif-geoloc-container');
        $('#data-geoloc-espace-producteur-container').show('slow');
      },
      error: function(jqXHR, textStatus, errorThrown) {
        console.log(textStatus, errorThrown);
      }
    });
  });

  $('#data-geoloc-espace-producteur-latlng-ok').on('mousedown', function() {
    $('#data-geoloc-espace-producteur-container').toggle('slow', function() {
      $('#espace-prd-modifier-geoloc').show();
      $('#data-geoloc-err-latlng').hide();
      $('#data-geoloc-updated-latlng').hide();
    });
    focusContainers();
  });

  $('#data-geoloc-espace-producteur-latlng-update').on('mousedown', function() {

    var pkprd = $(this).attr('data');
    var sitkn = $(this).attr('sitkn');
    var usridf = $(this).attr('usridf');
    var latlng = $('#data-geoloc-espace-producteur-latlng').val();

    if (isLatlngFormatException(latlng)) {
      $('#cet-modal-alerte-titre').text("Le format des coordonnées renseignées ne permet pas la prise en compte de votre demande.");
      $('#cet-modal-alerte-paragraphe').text("Afin de saisir les données dans un format correct, veuillez vous référer à l'aide en ligne proposée dans cette rubrique.");
      $('#cet-modal-alerte-btn-annuler').hide();
      $('#cet-modal-alerte-btn-primary').text("J'ai compris");
      $('#cet-modal-alerte-btn-primary').off();
      $('#cet-modal-alerte-btn-primary').on('mousedown', function() { $('#cet-modal-alerte').modal('hide'); });
      $('#cet-modal-alerte-btn').click(); 
    } else {
      $.ajax({
        url: '/src/app/controller/ajaxhandlers/cet.qstprod.controller.ajaxhandler.geoloc.producteur.php'
          + '?action=update' 
          + '&pkprd=' + pkprd 
          + '&sitkn=' + sitkn 
          + '&usridf=' + usridf
          + '&latlng=' + latlng.trim(),
        success: function(json) {
          var data = JSON.parse(json);
          $('#data-geoloc-updated-latlng').show('slow');
          $('#data-geoloc-err-latlng').hide();
          $('#etat-mdif-geoloc-producteur').html(data.msg);
          $('#data-geoloc-espace-producteur-latlng').val(data.lng + ';' + data.lat);
        },
        error: function(jqXHR, textStatus, errorThrown) {
          console.log(textStatus, errorThrown);
        }
      });
    }
  });

  $('#data-geoloc-espace-producteur-set-auto').on('mousedown', function() {

    var pkprd = $(this).attr('data');
    var sitkn = $(this).attr('sitkn');
    var usridf = $(this).attr('usridf');

    $.ajax({
      url: '/src/app/controller/ajaxhandlers/cet.qstprod.controller.ajaxhandler.geoloc.producteur.php'
        + '?action=geoloc-auto' 
        + '&pkprd=' + pkprd 
        + '&sitkn=' + sitkn 
        + '&usridf=' + usridf,
      success: function(json) {
        var data = JSON.parse(json);
        $('#data-geoloc-updated-latlng').show('slow');
        $('#data-geoloc-err-latlng').hide();
        $('#etat-mdif-geoloc-producteur').html(data.msg);
        $('#data-geoloc-espace-producteur-latlng').val('');
      },
      error: function(jqXHR, textStatus, errorThrown) {
        console.log(textStatus, errorThrown);
      }
    });
  });

  $('#espace-prd-modifier-mdp-envoyer').on('mousedown', function() {
    
    if (notEqualMdpMdpConf($('#qstprod-espace-prd-nouveau-mdp').val(), 
        $('#qstprod-espace-prd-conf-mdp').val())) {
      $('#cet-modal-alerte-titre').text("Les mots de passe renseignés ne sont pas identiques.");
      $('#cet-modal-alerte-paragraphe').text("Le mot de passe de confirmation n'est pas identique au mot de passe renseigné. Veuillez rectifier votre saisie.");
      $('#cet-modal-alerte-btn-annuler').hide();
      $('#cet-modal-alerte-btn-primary').text("J'ai compris");
      $('#cet-modal-alerte-btn-primary').off();
      $('#cet-modal-alerte-btn-primary').on('mousedown', function() { $('#cet-modal-alerte').modal('hide'); });
      $('#cet-modal-alerte-btn').click(); 
    } else {
      $.ajax({
        url: '/src/app/controller/ajaxhandlers/cet.qstprod.controller.ajaxhandler.mdpupdate.php'
          + '?pk=' + $(this).attr('data')
          + '&sitkn=' + $(this).attr('sitkn')
          + '&usridf=' + $(this).attr('usridf')
          + '&amdp=' + $('#qstprod-espace-prd-ancien-mdp').val()
          + '&nvmdp=' + $('#qstprod-espace-prd-nouveau-mdp').val()
          + '&nvmdpcnf=' + $('#qstprod-espace-prd-conf-mdp').val(),
        success: function(json) {
          var data = JSON.parse(json);

          $('#espace-prd-modifier-mdp-outcome').html(data.msg);
          if (data.etat === 'true') {
            $('#espace-prd-modifier-mdp-outcome').css('color', 'green');
          } else if (data.etat === 'false') {
            $('#espace-prd-modifier-mdp-outcome').css('color', 'red');
          }

          $('#espace-prd-modifier-mdp-outcome').show('slow');
        },
        error: function(jqXHR, textStatus, errorThrown) {
          console.log(textStatus, errorThrown);
        }
      });
    }

    // in any case : 
    $('#qstprod-espace-prd-ancien-mdp').val('');
    $('#qstprod-espace-prd-nouveau-mdp').val('');
    $('#qstprod-espace-prd-conf-mdp').val('');
  });

  $('#espace-prd-modifier-media').on('mousedown', function() {
    unFocusContainersExcept('espace-prd-mdif-medias-container');
    $('#data-media-espace-producteur-container').show('slow');
  });

  $(".custom-file-input").on("change", function() {
    var fileName = $(this).val().split("\\").pop();
    $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
  });

  // charger toutes les images existantes : 
  reloadMedia($('#espace-prd-pkprd-value').val(), 'producteur');
  
});

/** **************************************************************************************
 * Fonction liée à la modification des du mot de passe.
 *****************************************************************************************/
function notEqualMdpMdpConf(mdp, mdpConf) {
  if (mdp === mdpConf) return false;
  else return true;
}

/** ***************************************************************************************
 * Fonctions liées à la modification des coordonnées de cartographie.
 ******************************************************************************************/
function isLatlngFormatException(coordonnees) {
  try {
    var auth_chars = [',', ';', '-', '.', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
    var char_array = coordonnees.trim().replace(",", ";").replace(" ", "").split("");
    for (var i = 0; i < char_array.length; i++) if (auth_chars.indexOf(char_array[i]) < 0) return true;
    return false;
  } catch (error) {
    return true;
  }
}

/** ***************************************************************************************
 * Events sur gestion des médias producteur.
 ******************************************************************************************/
/**
 * Recharger un media et l'ajouter.
 */
function appendAllMedia(images) {
  
  var content = false;
  var logo_ajoute = false;
  var compte_img_ferme = 0;
  $('#espace-prd-media-listing').empty();
  for (var i = 0; i < images.length; i++) {
    content = true;
    if (images[i].cible === 'logo-ferme') logo_ajoute = true;
    else if (images[i].cible === 'media-ferme') ++compte_img_ferme;
    $('#espace-prd-media-listing').append('<button type="button" class="btn espace-prd-media-element-btn"><div><span class="badge espace-prd-media-element-desc">' + images[i].cible + '</span><span class="badge espace-prd-media-element-delete-btn" data="' + images[i].id + '" pkusr="' + images[i].fk_producteur + '" urlr="' + images[i].urlr + '"><i class="fas fa-folder-minus fa-2x"></i></span></div><img src="' + images[i].urlr + '" class="rounded mx-auto d-block espace-prd-media-element" height="128" alt="' + images[i].libelle + '"></button>');
  } 

  // Si aucune image alors notifier :
  if (!content) {
    $('#espace-prd-media-listing').append('<p style="margin: 12px; color: rgb(30,40,30) !important;">Aucune image ajouté pour le moment...</p>');
  }

  // Dans tous les cas, afficher le nombre d'images :
  $('#espace-prd-modifier-count').html(images.length);

  // Si media(s) trouvé(s), ajouter la fonctionnalité delete/suppression sur l'icone de suppression :
  $('.espace-prd-media-element-delete-btn').on('mousedown', function() {

    var urlr_delete = $(this).attr('urlr');
    var pkusr_delete = $(this).attr('pkusr');
    var id_media_delete = $(this).attr('data');
    $('#cet-modal-alerte-titre').text("Veuillez confirmer la suppression de l'image");
    $('#cet-modal-alerte-paragraphe').text("La suppression de l'image est définitive. Vous pouvez cependant télécharger à nouveau une image supprimée par erreur. Veuillez confirmer la suppression de l'image " + urlr_delete);
    $('#cet-modal-alerte-btn-annuler').text("Annuler");
    $('#cet-modal-alerte-btn-primary').text("Je confirme");
    $('#cet-modal-alerte-btn-primary').off();
    $('#cet-modal-alerte-btn-primary').on('mousedown', function() {
      $('#cet-modal-alerte').modal('hide');
      deleteMedia(id_media_delete, pkusr_delete, urlr_delete);
    });
    $('#cet-modal-alerte-btn-annuler').on('mousedown', function() { 
      $('#cet-modal-alerte').modal('hide'); 
    });
    $('#cet-modal-alerte-btn').click(); 
  });

  // finallement, vider les zones dropzone :
  clearAllFiles(2000);
  gestionZonesMedias(logo_ajoute, compte_img_ferme, 720);
}

/**
 * Recharger les medias.
 */
function reloadMedia(pk, tbl) {
  $.ajax({
    url: '/src/app/controller/ajaxhandlers/cet.annuaire.controller.ajaxhandler.media.php'
      + '?pk=' + pk
      + '&tbl=' + tbl,
    success: function(json) { appendAllMedia(JSON.parse(json)); },
    error: function(jqXHR, textStatus, errorThrown) {
      console.log(textStatus, errorThrown);
    }
  });
}

function deleteMedia(id_media, pk_producteur, urlr) {
  $.ajax({
    url: '/src/app/controller/media/cet.qstprod.controller.delete.media.php'
      + '?idm=' + id_media
      + '&pkprd=' + pk_producteur
      + '&urlr=' + urlr,
    success: function(json) { reloadMedia(pk_producteur, 'producteur'); },
    error: function(jqXHR, textStatus, errorThrown) {
      console.log(textStatus, errorThrown);
    }
  });
}

function clearAllFiles(t) {
  try {
      setTimeout(function() {  
      Dropzone.forElement("#cetFileDropzoneImgferme").removeAllFiles();
      Dropzone.forElement("#cetFileDropzoneImglogo").removeAllFiles();
    }, t);
  } catch (error) {
    console.log(error);
  }
}

function gestionZonesMedias(logoAjoute, compteImgFerme, t) {

  setTimeout(function() { 

      if (logoAjoute) {
        $('#cet-file-upload-dropzone-bloc-logo-container').hide('slow');
      } else {
        $('#cet-file-upload-dropzone-bloc-logo-container').show('slow');
      }

      if (compteImgFerme >= 8) {
        $('#cet-file-upload-dropzone-bloc-imgferme-container').hide('slow');
      } else {
        $('#cet-file-upload-dropzone-bloc-imgferme-container').show('slow');
      }
    }, t);
}

const containers = [
  'espace-prd-mdif-global-container', 
  'espace-prd-mdif-geoloc-container',
  'espace-prd-mdif-medias-container',
  ];
function unFocusContainersExcept(container) {
  for (var i = 0; i < containers.length; i++) {
    if (containers[i] === container) continue;
    $('#' + containers[i]).hide('slow');
  }
}
function focusContainers() {
  for (var i = 0; i < containers.length; i++) {
    $('#' + containers[i]).show('slow');
  }
  setTimeout(function() { scrollTowards('espace-prd-header-area'); }, 300);
}

/** ******************************************************************************************
 * pilotage de dropzonejs.
 ********************************************************************************************/
Dropzone.options.cetFileDropzoneImgferme = {
  init: function() {
    this.on("success", function(file) { 
      var pk = $('#espace-prd-pkprd-value').val();
      reloadMedia(pk, 'producteur');
    });
  }
};

Dropzone.options.cetFileDropzoneImglogo = {
  init: function() {
    this.on("success", function(file) { 
      var pk = $('#espace-prd-pkprd-value').val();
      reloadMedia(pk, 'producteur');
    });
  }
};